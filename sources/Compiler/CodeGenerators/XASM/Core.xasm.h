"new:\n"
"ldw $ar, ($lb) -4\n"
"push $ar\n"
"insc AllocMem\n"
"mov $r1, 1\n"
"stw $r1, ($ar) 0\n"
"ldw $r1, ($lb) -8\n"
"stw $r1, ($ar) 4\n"
"ldw $r1, ($lb) -12\n"
"stw $r1, ($ar) 8\n"
"ret 3\n"
"inc_ref:\n"
"mov $cf, $xr\n"
"je .end\n"
"ldw $r0, ($xr) 0\n"
"inc $r0\n"
"stw $r0, ($xr) 0\n"
".end:\n"
"ret\n"
"dec_ref:\n"
"mov $cf, $xr\n"
"je .end\n"
"ldw $r0, ($xr) 0\n"
"sub $cf, $r0, 1\n"
"je .rel\n"
"dec $r0\n"
"stw $r0, ($xr) 0\n"
"ret\n"
".rel:\n"
"ldw $r0, ($xr) 8\n"
"ldw $r0, ($r0) 0\n"
"push $xr\n"
"call $r0\n"
";pop $xr\n"
";push $xr\n"
"insc FreeMem\n"
".end:\n"
"ret\n"
"dynamic_cast:\n"
"ldw $cf, ($lb) -4\n"
"je .end\n"
"mov $ar, $cf\n"
"ldw $r1, ($ar) 4\n"
"ldw $r2, ($lb) -8\n"
"ldw $r3, ($lb) -12\n"
"add $r3, $r3, $r2\n"
"cmp $r2, $r1\n"
"jg .end\n"
"cmp $r1, $r3\n"
"jg .end\n"
"ret 3\n"
".end:\n"
"mov $ar, 0\n"
"ret 3\n"
"String.copy_literal:\n"
"ldw $r0, ($lb) -4\n"
"push 24\n"
"insc AllocMem\n"
"mov $xr, $ar\n"
"push $r0\n"
"call CString.Pinit,R@String?source\n"
"mov $ar, $xr\n"
"ret 1\n"
"CObject.Prelease:\n"
"CObject.Pinit:\n"
"ret\n"
"CObject.PrefCount:\n"
"ldw $ar, ($xr) 0\n"
"ret\n"
"CObject.PtypeID:\n"
"ldw $ar, ($xr) 4\n"
"ret\n"
"CObject.Pequals,R@Object?rhs:\n"
"ldw $r0, ($lb) -4\n"
"mov $cf, $r0\n"
"je .end\n"
"ldw $r1, ($xr) 4\n"
"ldw $r2, ($r0) 4\n"
"cmp $r1, $r2\n"
"jne .end\n"
"mov $ar, 1\n"
"ret 1\n"
".end:\n"
"mov $ar, 0\n"
"ret 1\n"
"CObject.PtoString:\n"
"mov $ar, 0\n"
"ret\n"
"CObject.Ppointer:\n"
"add $ar, $xr, 12\n"
"ret\n"
"Object.vtable:\n"
".word @CObject.Prelease\n"
".word @CObject.Pinit\n"
".word @CObject.PtypeID\n"
".word @CObject.PrefCount\n"
".word @CObject.Pequals,R@Object?rhs\n"
".word @CObject.PtoString\n"
".word @CObject.Ppointer\n"
"CString.Prelease:\n"
"ldw $r0, ($xr) 20\n"
"push $r0\n"
"insc FreeMem\n"
"ret\n"
"CString.Pinit:\n"
"mov $r0, 0\n"
"stw $r0, ($xr) 12\n"
"mov $r1, 16\n"
"stw $r1, ($xr) 16\n"
"push 16\n"
"insc AllocMem\n"
"stw $ar, ($xr) 20\n"
"stw $r0, ($ar) 0\n"
"ret 1\n"
"CString.Pinit,R@String?source:\n"
"ldw $r0, ($lb) -4\n"
"push 20\n"
"push $r0\n"
"push $xr\n"
"insc CopyMem\n"
"ldw $r2, ($r0) 12\n"
"inc $r2\n"
"push $r2\n"
"insc AllocMem\n"
"stw $ar, ($xr) 20\n"
"ldw $r0, ($r0) 20\n"
"push $r2\n"
"push $r0\n"
"push $ar\n"
"insc CopyMem\n"
"ret 1\n"
"CString.PtoString:\n"
"mov $ar, $xr\n"
"ret\n"
"CString.Pcopy:\n"
"push @String.vtable\n"
"push 1\n"
"push 24\n"
"call new\n"
"pop $r1\n"
"ldw $r0, ($lb) -4\n"
"push $r1\n"
"push $r1\n"
"mov $xr, $r0\n"
"call CString.Pinit,R@String?source\n"
"pop $ar\n"
"ret\n"
"CString.Psize:\n"
"ldw $ar, ($xr) 12\n"
"ret\n"
"CString.Presize,I?size:\n"
"ret 1\n"
"CString.Pempty:\n"
"ldw $cf, ($xr) 12\n"
"je .empty\n"
"mov $ar, 0\n"
"ret\n"
".empty:\n"
"mov $ar, 1\n"
"ret\n"
"CString.Padd,R@String?rhs:\n"
"ret 1\n"
"CString.PsetChar,I?pos,I?char:\n"
"ret 2\n"
"CString.PgetChar,I?pos:\n"
"mov $ar, 0\n"
"ret 1\n"
"CString.Ppointer:\n"
"ldw $ar, ($xr) 20\n"
"ret\n"
"String.vtable:\n"
".word @CString.Prelease\n"
".word @CString.Pinit\n"
".word @CObject.PtypeID\n"
".word @CObject.PrefCount\n"
".word @CObject.Pequals,R@Object?rhs\n"
".word @CString.PtoString\n"
".word @CString.Ppointer\n"
".word @CString.Pinit,R@String?source\n"
".word @CString.Pcopy\n"
".word @CString.Psize\n"
".word @CString.Presize,I?size\n"
".word @CString.Pempty\n"
".word @CString.Padd,R@String?rhs\n"
".word @CString.PsetChar,I?pos,I?char\n"
".word @CString.PgetChar,I?pos\n"
"CArray.Prelease:\n"
"ldw $r0, ($xr) 12\n"
"ldw $r1, ($xr) 20\n"
"mov $xr, $r1\n"
"sll $r0, $r0, 2\n"
"add $r0, $r0, $xr\n"
".loop:\n"
"cmp $xr, $r0\n"
"jge .end\n"
"push $xr\n"
"push $r0\n"
"push $r1\n"
"call dec_ref\n"
"pop $r1\n"
"pop $r0\n"
"pop $xr\n"
"add $xr, $xr, 4\n"
"jmp .loop\n"
".end:\n"
"push $r1\n"
"insc FreeMem\n"
"ret\n"
"CArray.Pinit:\n"
"ret\n"
"CArray.Pinit,I?size:\n"
"ret 1\n"
"Array.vtable:\n"
".word @CArray.Prelease\n"
".word @CArray.Pinit\n"
".word @CObject.PtoString\n"
".word @CArray.Pinit,I?size\n"
"CBoolArray.Prelease:\n"
"ldw $r0, ($xr) 20\n"
"push $r0\n"
"insc FreeMem\n"
"ret\n"
"CBoolArray.Pinit:\n"
"ret\n"
"CBoolArray.Pinit,I?size:\n"
"ldw $cf, ($lb) -8\n"
"stw $cf, ($xr) 12\n"
"stw $cf, ($xr) 16\n"
"add $cf, $cf, 7\n"
"slr $cf, $cf, 3\n"
"push $cf\n"
"insc AllocMem\n"
"stw $ar, ($xr) 20\n"
"mov $r0, 0\n"
".loop:\n"
"jle .end\n"
"stw $r0, ($ar) 0\n"
"inc $ar\n"
"dec $cf\n"
"jmp .loop\n"
".end:\n"
"ret 1\n"
"BoolArray.vtable:\n"
".word @CBoolArray.Prelease\n"
".word @CBoolArray.Pinit\n"
".word @CObject.PtoString\n"
".word @CBoolArray.Pinit,I?size\n"
